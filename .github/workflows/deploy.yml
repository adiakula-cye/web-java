name: CI/CD Deploy Java App to Tomcat10 on EC2 (No Maven)

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up Java (optional, for future builds)
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      # 3. Manually build WAR file
      - name: Build WAR file manually (no Maven)
        run: |
          echo "=== Building WAR manually ==="
          mkdir -p target
          
          # Adjust these if your web.xml and JSPs are in a different folder
          cd Web-INF
          jar -cvf ../target/ROOT.war *
          cd ..
          
          echo "=== WAR build complete ==="
          ls -la target/

      # 4. Verify WAR file exists
      - name: Verify WAR file
        run: |
          echo "=== Listing target directory ==="
          ls -la target/
          
          if [ ! -f "target/ROOT.war" ]; then
            echo "ERROR: ROOT.war not found!"
            exit 1
          fi
          echo "WAR file ready for deployment."

      # 5. Create SSH key file
      - name: Create SSH key file
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # 6. Upload WAR file to EC2
      - name: Upload WAR to EC2
        run: |
          echo "=== Preparing EC2 for WAR upload ==="
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} \
            "sudo rm -rf /tmp/ROOT.war; sudo touch /tmp/ROOT.war; sudo chmod 666 /tmp/ROOT.war"

          echo "=== Uploading WAR file ==="
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no target/ROOT.war \
            ubuntu@${{ secrets.EC2_HOST }}:/tmp/ROOT.war

      # 7. Deploy WAR on Tomcat
      - name: Deploy WAR on Tomcat10
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Starting Deployment ==="
            
            echo "1. Stop Tomcat..."
            sudo systemctl stop tomcat10 || true

            echo "2. Clean old deployments..."
            sudo rm -rf /var/lib/tomcat10/webapps/ROOT /var/lib/tomcat10/webapps/ROOT.war

            echo "3. Copy new WAR..."
            sudo cp /tmp/ROOT.war /var/lib/tomcat10/webapps/
            sudo chown tomcat:tomcat /var/lib/tomcat10/webapps/ROOT.war
            sudo chmod 644 /var/lib/tomcat10/webapps/ROOT.war

            echo "4. Extract WAR..."
            sudo mkdir -p /var/lib/tomcat10/webapps/ROOT
            sudo -u tomcat unzip -o /var/lib/tomcat10/webapps/ROOT.war -d /var/lib/tomcat10/webapps/ROOT/
            sudo chown -R tomcat:tomcat /var/lib/tomcat10/webapps/ROOT/
            sudo chmod -R 755 /var/lib/tomcat10/webapps/ROOT/

            echo "5. Start Tomcat..."
            sudo systemctl start tomcat10

            echo "6. Wait and verify..."
            sleep 20
            sudo systemctl status tomcat10 --no-pager
            echo "=== Deployment Completed Successfully ==="

